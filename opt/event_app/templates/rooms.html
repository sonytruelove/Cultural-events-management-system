{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Ресурсы организации</h1>

    <ul class="nav resources-tabs mb-4" id="resourcesTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="rooms-tab" data-bs-toggle="tab" data-bs-target="#rooms" type="button">
                <i class="bi bi-building"></i> Помещения
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="employees-tab" data-bs-toggle="tab" data-bs-target="#employees" type="button">
                <i class="bi bi-people"></i> Сотрудники
            </button>
        </li>
    </ul>

<div class="tab-content" id="resourcesTabsContent">
    <div class="tab-pane fade show active" id="rooms" role="tabpanel" aria-labelledby="rooms-tab">
        <div class="d-flex justify-content-end mb-4 action-buttons gap-2">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
                <i class="bi bi-funnel"></i> 
            </button>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addRoomModal">
                <i class="bi bi-plus-lg"></i> 
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover" id="roomsTable">
                <thead class="table-light">
                    <tr>
                        <th data-sort="name">Название</th>
                        <th data-sort="room_type_name">Тип</th>
                        <th class="text-end" data-sort="capacity">Вместимость (до)</th>
                        <th data-sort="address">Адрес</th>
                        <th data-sort="is_external">Тип ресурса</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for room in rooms %}
                    <tr>
                        <td>{{ room.name }}</td>
                        <td>{{ room.room_type_name }}</td>
                        <td class="text-end font-monospace">{{ room.capacity }}</td>
                        <td>{{ room.address }}</td>
                        <td>
                            <span class="badge {{ 'bg-warning' if room.is_external else 'bg-success' }}">
                                {{ 'Внешний' if room.is_external else 'Внутренний' }}
                            </span>
                        </td>
                        <td>
                            <a href="/rooms/{{ room.id }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-info-circle"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteRoom({{ room.id }}, '{{ room.name }}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center">Помещения не найдены</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="tab-pane fade" id="employees" role="tabpanel" aria-labelledby="employees-tab">
        <div class="d-flex justify-content-end mb-4 action-buttons gap-2">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#employeeFilterModal">
                <i class="bi bi-funnel"></i>
            </button>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover" id="employeesTable">
                <thead class="table-light">
                    <tr>
                        <th data-sort="full_name">ФИО</th>
                        <th data-sort="position">Должность</th>
                        <th data-sort="is_external">Тип</th>
                        <th data-sort="contact_info">Контакты</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for employee in employees %}
                    <tr>
                        <td>{{ employee.full_name }}</td>
                        <td>{{ employee.position }}</td>
                        <td>
                            <span class="badge {{ 'bg-warning' if employee.is_external else 'bg-success' }}">
                                {{ 'Внешний' if employee.is_external else 'Внутренний' }}
                            </span>
                        </td>
                        <td>{{ employee.contact_info if employee.contact_info else '—' }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" 
                                data-bs-target="#editEmployeeModal{{ employee.id }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" 
                                onclick="confirmDeleteEmployee({{ employee.id }}, '{{ employee.full_name }}')">
                                <i class="bi bi-x"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center">Сотрудники не найдены</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div> 

<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Фильтры помещений</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="roomFilterForm">
                    <div class="mb-3">
                        <label for="roomNameFilter" class="form-label fw-bold fw-bold">Название</label>
                        <input type="text" class="form-control" id="roomNameFilter" placeholder="Поиск по названию">
                    </div>
                    <div class="mb-3" style="max-width: 350px;">
                        <label for="roomTypeFilter" class="form-label fw-bold fw-bold">Тип помещения</label>
                        <select class="form-select" id="roomTypeFilter">
                            <option value="">Все типы</option>
                            {% for room_type in room_types %}
                                <option value="{{ room_type.id }}">{{ room_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="roomCapacityFilter" class="form-label fw-bold fw-bold">Вместимость (до)</label>
                        <input type="number" class="form-control" id="roomCapacityFilter" min="1" placeholder="Минимальная вместимость" style="max-width: 150px;">
                    </div>
                    <div class="mb-3">
                        <label for="roomAddressFilter" class="form-label fw-bold fw-bold">Адрес</label>
                        <input type="text" class="form-control" id="roomAddressFilter" placeholder="Поиск по адресу">
                    </div>
                    <div class="mb-3">
                        <label for="roomExternalFilter" class="form-label fw-bold fw-bold">Тип ресурса</label>
                        <select class="form-select" id="roomExternalFilter" style="max-width: 150px;">
                            <option value="">Все</option>
                            <option value="true">Внешние</option>
                            <option value="false">Внутренние</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="resetRoomFilters()">Сбросить</button>
                <button type="button" class="btn btn-primary" onclick="applyRoomFilters()">Применить</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addRoomModal" tabindex="-1" aria-labelledby="addRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRoomModalLabel">Добавить новое помещение</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="/rooms/add" enctype="multipart/form-data" id="addRoomForm">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="isExternalRoom" name="is_external">
                                <label class="form-check-label" for="isExternalRoom">Внешний ресурс</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="externalRoomFields" style="display: none;">
                                <label for="externalRoomUrl" class="form-label fw-bold fw-bold">Ссылка на внешний ресурс</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="externalRoomUrl" name="external_url" placeholder="https://flamp.ru/...">
                                    <button class="btn btn-outline-secondary" type="button" id="parseRoomBtn">Заполнить</button>
                                </div>
                                <div class="form-text">Укажите ссылку на заведение в flamp.ru</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="roomName" class="form-label fw-bold fw-bold">Название помещения*</label>
                                <input type="text" class="form-control" id="roomName" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="roomType" class="form-label fw-bold">Тип помещения*</label>
                                <select class="form-select" id="roomType" name="room_type_id" style="max-width: 300px;" required>
                                    <option value="" selected disabled>Выберите тип</option>
                                    {% for room_type in room_types %}
                                        <option value="{{ room_type.id }}">{{ room_type.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="roomCapacity" class="form-label fw-bold fw-bold">Вместимость (человек)*</label>
                                <input type="number" class="form-control" id="roomCapacity" name="capacity" min="1" style="max-width: 100px;" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="roomAddress" class="form-label fw-bold fw-bold">Адрес*</label>
                                <input type="text" class="form-control" id="roomAddress" name="address" required>
                            </div>
                            <div class="mb-3">
                                <label for="roomDescription" class="form-label fw-bold fw-bold">Описание</label>
                                <textarea class="form-control" id="roomDescription" name="description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="roomImage" class="form-label fw-bold fw-bold">Изображение помещения</label>
                                <input type="file" class="form-control" id="roomImage" name="image" accept="image/*">
                                <div class="form-text">Рекомендуемый размер: 800x600px, формат JPG или PNG</div>
                                <div id="imagePreviewContainer" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">Добавить помещение</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% for employee in employees %}
<div class="modal fade" id="editEmployeeModal{{ employee.id }}" tabindex="-1" aria-labelledby="editEmployeeModalLabel{{ employee.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editEmployeeModalLabel{{ employee.id }}">Редактировать сотрудника</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="/employees/{{ employee.id }}/update" id="editEmployeeForm{{ employee.id }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editFullName{{ employee.id }}" class="form-label fw-bold">ФИО*</label>
                        <input type="text" class="form-control" id="editFullName{{ employee.id }}" 
                               name="full_name" value="{{ employee.full_name }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPosition{{ employee.id }}" class="form-label fw-bold">Должность*</label>
                        <input type="text" class="form-control" id="editPosition{{ employee.id }}" 
                               name="position" value="{{ employee.position }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editContactInfo{{ employee.id }}" class="form-label fw-bold">Контактная информация</label>
                        <input type="text" class="form-control" id="editContactInfo{{ employee.id }}" 
                               name="contact_info" value="{{ employee.contact_info or '' }}">
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="editIsExternal{{ employee.id }}" 
                               name="is_external" {{ 'checked' if employee.is_external else '' }}>
                        <label class="form-check-label" for="editIsExternal{{ employee.id }}">Внешний сотрудник</label>
                    </div>
                    <div class="mb-3" id="editExternalUrlContainer{{ employee.id }}" 
                         style="{{ 'display: block;' if employee.is_external else 'display: none;' }}">
                        <label for="editExternalUrl{{ employee.id }}" class="form-label fw-bold">Ссылка на внешний ресурс</label>
                        <input type="text" class="form-control" id="editExternalUrl{{ employee.id }}" 
                               name="external_url" value="{{ employee.external_url or '' }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
<div class="modal fade" id="employeeFilterModal" tabindex="-1" aria-labelledby="employeeFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="employeeFilterModalLabel">Фильтры сотрудников</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="employeeFilterForm">
                    <div class="mb-3">
                        <label for="employeeNameFilter" class="form-label fw-bold">ФИО</label>
                        <input type="text" class="form-control" id="employeeNameFilter" placeholder="Поиск по ФИО">
                    </div>
                    <div class="mb-3">
                        <label for="employeePositionFilter" class="form-label fw-bold">Должность</label>
                        <input type="text" class="form-control" id="employeePositionFilter" placeholder="Поиск по должности">
                    </div>
                    <div class="mb-3">
                        <label for="employeeTypeFilter" class="form-label fw-bold">Тип сотрудника</label>
                        <select class="form-select" id="employeeTypeFilter" style="max-width: 150px;">
                            <option value="">Все</option>
                            <option value="false">Внутренние</option>
                            <option value="true">Внешние</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="resetEmployeeFilters()">Сбросить</button>
                <button type="button" class="btn btn-primary" onclick="applyEmployeeFilters()">Применить</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEmployeeModalLabel">Добавить сотрудника</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="/employees/add" id="addEmployeeForm">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="isExternalEmployee" name="is_external">
                                <label class="form-check-label" for="isExternalEmployee">Внешний сотрудник</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="externalEmployeeFields" style="display: none;">
                                <label for="externalEmployeeUrl" class="form-label fw-bold">Ссылка на резюме (hh.ru)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="externalEmployeeUrl" name="external_url" placeholder="https://hh.ru/resume/...">
                                    <button class="btn btn-outline-secondary" type="button" id="parseEmployeeBtn">Заполнить</button>
                                </div>
                                <div class="form-text">Укажите ссылку на резюме в hh.ru</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="employeeFullName" class="form-label fw-bold">ФИО*</label>
                                <input type="text" class="form-control" id="employeeFullName" name="full_name" required>
                            </div>
                            <div class="mb-3">
                                <label for="employeePosition" class="form-label fw-bold">Должность*</label>
                                <input type="text" class="form-control" id="employeePosition" name="position" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="employeeContactInfo" class="form-label fw-bold">Контактная информация</label>
                                <input type="text" class="form-control" id="employeeContactInfo" name="contact_info">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmationText">Вы уверены, что хотите удалить это помещение?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Удалить</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
let roomToDelete = null;
let employeeToDelete = null;

function confirmDeleteRoom(roomId, roomName) {
    roomToDelete = roomId;
    document.getElementById('deleteConfirmationText').textContent = 
        `Вы уверены, что хотите удалить помещение "${roomName}"?`;
    
    const deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
    deleteModal.show();
}

function deleteRoom(roomId) {
    fetch(`/rooms/${roomId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Ошибка при удалении помещения');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при удалении помещения');
    })
    .finally(() => {
        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
        deleteModal.hide();
        roomToDelete = null;
    });
}

function confirmDeleteEmployee(id, name) {
    employeeToDelete = id;
    document.getElementById('deleteConfirmationText').textContent = 
        `Вы уверены, что хотите удалить сотрудника "${name}"?`;
    
    const deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
    deleteModal.show();
}

function deleteEmployee(employeeId) {
    fetch(`/employees/${employeeId}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Ошибка при удалении сотрудника');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при удалении сотрудника');
    })
    .finally(() => {
        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
        deleteModal.hide();
        employeeToDelete = null;
    });
}

function applyRoomFilters() {
    const nameFilter = document.getElementById('roomNameFilter')?.value.toLowerCase() || '';
    const typeFilter = document.getElementById('roomTypeFilter')?.value || '';
    const capacityFilter = parseInt(document.getElementById('roomCapacityFilter')?.value) || 0;
    const addressFilter = document.getElementById('roomAddressFilter')?.value.toLowerCase() || '';
    const externalFilter = document.getElementById('roomExternalFilter')?.value || '';
    
    const rows = document.querySelectorAll('#roomsTable tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        if (row.cells.length < 5) return;
        
        const name = row.cells[0].textContent.toLowerCase();
        const type = row.cells[1].textContent;
        const capacity = parseInt(row.cells[2].textContent) || 0;
        const address = row.cells[3].textContent.toLowerCase();
        const isExternal = row.cells[4].querySelector('.badge').textContent.includes('Внешний');
        const externalValue = isExternal ? 'true' : 'false';
        
        const matchesName = !nameFilter || name.includes(nameFilter);
        const matchesType = !typeFilter || type === typeFilter;
        const matchesCapacity = !capacityFilter || capacity <= capacityFilter;
        const matchesAddress = !addressFilter || address.includes(addressFilter);
        const matchesExternal = !externalFilter || externalValue === externalFilter;
        
        if (matchesName && matchesType && matchesCapacity && matchesAddress && matchesExternal) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    const noResultsRow = document.querySelector('#roomsTable tbody tr:last-child');
    if (noResultsRow && noResultsRow.cells.length === 1) {
        noResultsRow.style.display = visibleCount === 0 ? '' : 'none';
    }
    
    const filterModal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
    if (filterModal) filterModal.hide();
}

function sortTable(tableId, columnIndex, sortKey) {
    const table = document.getElementById(tableId);
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr:not([style*="display: none"])'));
    
    const header = table.querySelector(`th[data-sort="${sortKey}"]`);
    const currentOrder = header.getAttribute('data-order') || 'asc';
    const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
    
    table.querySelectorAll('th[data-sort]').forEach(th => th.removeAttribute('data-order'));
    header.setAttribute('data-order', newOrder);
    
    rows.sort((a, b) => {
        let aValue = a.cells[columnIndex].textContent.trim();
        let bValue = b.cells[columnIndex].textContent.trim();
        
        if (sortKey === 'capacity') {
            aValue = parseInt(aValue) || 0;
            bValue = parseInt(bValue) || 0;
        }
        else if (sortKey === 'is_external') {
            aValue = a.cells[columnIndex].querySelector('.badge').textContent.includes('Внешний') ? 1 : 0;
            bValue = b.cells[columnIndex].querySelector('.badge').textContent.includes('Внешний') ? 1 : 0;
        }
        
        if (aValue < bValue) return newOrder === 'asc' ? -1 : 1;
        if (aValue > bValue) return newOrder === 'asc' ? 1 : -1;
        return 0;
    });
    
    while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
    }
    
    rows.forEach(row => tbody.appendChild(row));
}


function resetRoomFilters() {
    document.getElementById('roomNameFilter').value = '';
    document.getElementById('roomTypeFilter').value = '';
    document.getElementById('roomCapacityFilter').value = '';
    document.getElementById('roomAddressFilter').value = '';
    document.getElementById('roomExternalFilter').value = '';
    
    const rows = document.querySelectorAll('#roomsTable tbody tr');
    rows.forEach(row => {
        row.style.display = '';
    });
    
    const noResultsRow = document.querySelector('#roomsTable tbody tr:last-child');
    if (noResultsRow && noResultsRow.cells.length === 1) {
        noResultsRow.style.display = rows.length <= 1 ? '' : 'none';
    }
    
    const filterModal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
    if (filterModal) filterModal.hide();
}

function applyEmployeeFilters() {
    const nameFilter = document.getElementById('employeeNameFilter')?.value.toLowerCase() || '';
    const positionFilter = document.getElementById('employeePositionFilter')?.value.toLowerCase() || '';
    const typeFilter = document.getElementById('employeeTypeFilter')?.value || '';
    
    const rows = document.querySelectorAll('#employeesTable tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        if (row.cells.length < 5) return;
        
        const name = row.cells[0].textContent.toLowerCase();
        const position = row.cells[1].textContent.toLowerCase();
        const isExternal = row.cells[2].querySelector('.badge').textContent.includes('Внешний');
        const externalValue = isExternal ? 'true' : 'false';
        
        const matchesName = !nameFilter || name.includes(nameFilter);
        const matchesPosition = !positionFilter || position.includes(positionFilter);
        const matchesType = !typeFilter || externalValue === typeFilter;
        
        if (matchesName && matchesPosition && matchesType) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    const noResultsRow = document.querySelector('#employeesTable tbody tr:last-child');
    if (noResultsRow && noResultsRow.cells.length === 1) {
        noResultsRow.style.display = visibleCount === 0 ? '' : 'none';
    }
    
    const filterModal = bootstrap.Modal.getInstance(document.getElementById('employeeFilterModal'));
    if (filterModal) filterModal.hide();
}

function resetEmployeeFilters() {
    document.getElementById('employeeNameFilter').value = '';
    document.getElementById('employeePositionFilter').value = '';
    document.getElementById('employeeTypeFilter').value = '';
    
    const rows = document.querySelectorAll('#employeesTable tbody tr');
    rows.forEach(row => {
        row.style.display = '';
    });
    
    const noResultsRow = document.querySelector('#employeesTable tbody tr:last-child');
    if (noResultsRow && noResultsRow.cells.length === 1) {
        noResultsRow.style.display = rows.length <= 1 ? '' : 'none';
    }
    
    const filterModal = bootstrap.Modal.getInstance(document.getElementById('employeeFilterModal'));
    if (filterModal) filterModal.hide();
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alertDiv.role = 'alert';
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px'; 
    alertDiv.style.zIndex = '9999';
    alertDiv.style.maxWidth = '400px';
    
    alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="flex-grow-1">${message}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        const bsAlert = new bootstrap.Alert(alertDiv);
        bsAlert.close();
    }, 5000);
}

document.addEventListener('DOMContentLoaded', function() {
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', function() {
            if (roomToDelete) {
                deleteRoom(roomToDelete);
            } else if (employeeToDelete) {
                deleteEmployee(employeeToDelete);
            }
        });
    }
    document.querySelectorAll('#roomsTable th[data-sort]').forEach((th, index) => {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
            const sortKey = th.getAttribute('data-sort');
            sortTable('roomsTable', index, sortKey);
        });
    });
    
    document.querySelectorAll('#employeesTable th[data-sort]').forEach((th, index) => {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
            const sortKey = th.getAttribute('data-sort');
            sortTable('employeesTable', index, sortKey);
        });
    });
    
    const isExternalEmployee = document.getElementById('isExternalEmployee');
    if (isExternalEmployee) {
        isExternalEmployee.addEventListener('change', function() {
            const externalFields = document.getElementById('externalEmployeeFields');
            if (this.checked) {
                externalFields.style.display = 'block';
            } else {
                externalFields.style.display = 'none';
                document.getElementById('externalEmployeeUrl').value = '';
            }
        });
    }
    
    const isExternalRoom = document.getElementById('isExternalRoom');
    if (isExternalRoom) {
        isExternalRoom.addEventListener('change', function() {
            const externalFields = document.getElementById('externalRoomFields');
            if (this.checked) {
                externalFields.style.display = 'block';
            } else {
                externalFields.style.display = 'none';
                document.getElementById('externalRoomUrl').value = '';
            }
        });
    }
    
    const roomImageInput = document.getElementById('roomImage');
    if (roomImageInput) {
        roomImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            const maxSize = 10 * 1024 * 1024; 
            if (file.size > maxSize) {
                alert('Размер файла не должен превышать 10MB');
                e.target.value = '';
                return;
            }
            
            reader.onload = function(e) {
                let previewContainer = document.getElementById('imagePreviewContainer');
                if (!previewContainer) {
                    previewContainer = document.createElement('div');
                    previewContainer.id = 'imagePreviewContainer';
                    previewContainer.className = 'mt-2';
                    document.querySelector('#addRoomModal .modal-body').appendChild(previewContainer);
                }
                
                previewContainer.innerHTML = '';
                
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'img-thumbnail';
                img.style.maxHeight = '200px';
                previewContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    }
    
    const parseRoomBtn = document.getElementById('parseRoomBtn');
    if (parseRoomBtn) {
        parseRoomBtn.addEventListener('click', async function() {
            const url = document.getElementById('externalRoomUrl').value.trim();
            if (!url) {
                alert('Пожалуйста, введите URL заведения на flamp.ru');
                return;
            }
            
            if (!url.includes('flamp.ru')) {
                alert('Пожалуйста, введите корректную ссылку на flamp.ru');
                return;
            }
            
            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Парсинг...';
            
            try {
                const response = await fetch('/api/parse/flamp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        url: url
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('roomName').value = data.data.name || '';
                    document.getElementById('roomAddress').value = data.data.address || '';
                    document.getElementById('roomCapacity').value = data.data.capacity || 50;
                    document.getElementById('roomDescription').value = data.data.description || '';
                    document.getElementById('roomType').value = data.data.room_type_id || 1;
                    
                    let parsedDataField = document.getElementById('parsedDataField');
                    if (!parsedDataField) {
                        parsedDataField = document.createElement('input');
                        parsedDataField.type = 'hidden';
                        parsedDataField.id = 'parsedDataField';
                        parsedDataField.name = 'parsed_data';
                        document.getElementById('addRoomForm').appendChild(parsedDataField);
                    }
                    parsedDataField.value = JSON.stringify(data.data);
                    
                    document.getElementById('isExternalRoom').checked = true;
                    document.getElementById('externalRoomFields').style.display = 'block';
                    
                    showAlert('Данные успешно загружены из flamp.ru', 'success');
                } else {
                    showAlert('Ошибка при парсинге: ' + (data.error || 'Неизвестная ошибка'), 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Ошибка при отправке запроса', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
    }
    
    const parseEmployeeBtn = document.getElementById('parseEmployeeBtn');
    if (parseEmployeeBtn) {
        parseEmployeeBtn.addEventListener('click', async function() {
            const url = document.getElementById('externalEmployeeUrl').value.trim();
            if (!url) {
                showAlert('Пожалуйста, введите URL резюме на hh.ru', 'danger');
                return;
            }

            if (!url.includes('hh.ru/resume/')) {
                showAlert('Некорректная ссылка на резюме. Пример: https://hh.ru/resume/123abc...', 'danger');
                return;
            }
                        
            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Парсинг...';
            
            try {
                const response = await fetch('/api/parse/hh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        url: url
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('employeeFullName').value = data.data.full_name || '';
                    document.getElementById('employeePosition').value = data.data.position || '';
                    document.getElementById('employeeContactInfo').value = data.data.contact_info || '';
                    
                    let parsedDataField = document.getElementById('parsedEmployeeDataField');
                    if (!parsedDataField) {
                        parsedDataField = document.createElement('input');
                        parsedDataField.type = 'hidden';
                        parsedDataField.id = 'parsedEmployeeDataField';
                        parsedDataField.name = 'parsed_data';
                        document.getElementById('addEmployeeForm').appendChild(parsedDataField);
                    }
                    parsedDataField.value = JSON.stringify(data.data);
                    
                    document.getElementById('isExternalEmployee').checked = true;
                    document.getElementById('externalEmployeeFields').style.display = 'block';
                    
                    showAlert('Данные успешно загружены из hh.ru', 'success');
                } else {
                    showAlert('Ошибка при парсинге: ' + (data.error || 'Неизвестная ошибка') + 
                              '. Убедитесь, что ссылка ведет на конкретное резюме.', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Ошибка при отправке запроса', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
    }
    
    {% for employee in employees %}
    const editIsExternal{{ employee.id }} = document.getElementById('editIsExternal{{ employee.id }}');
    if (editIsExternal{{ employee.id }}) {
        editIsExternal{{ employee.id }}.addEventListener('change', function() {
            const container = document.getElementById('editExternalUrlContainer{{ employee.id }}');
            if (this.checked) {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        });
    }
    
    const editEmployeeForm{{ employee.id }} = document.getElementById('editEmployeeForm{{ employee.id }}');
    if (editEmployeeForm{{ employee.id }}) {
        editEmployeeForm{{ employee.id }}.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(this);
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    showAlert('Ошибка при обновлении: ' + (data.error || 'Неизвестная ошибка'), 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Ошибка сети', 'danger');
            }
        });
    }
    {% endfor %}
    
    const addEmployeeForm = document.getElementById('addEmployeeForm');
    if (addEmployeeForm) {
        addEmployeeForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const response = await fetch('/employees/add', {
                    method: 'POST',
                    body: new FormData(this)
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('Ошибка: ' + (error.message || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ошибка сети');
            }
        });
    }
});
const style = document.createElement('style');
style.textContent = `
th[data-sort] {
    cursor: pointer;
    position: relative;
}

th[data-sort]:hover {
    background-color: #f8f9fa;
}

th[data-order]::after {
    content: ' ↕';
    font-size: 0.8em;
    position: absolute;
    right: 8px;
}

th[data-order="asc"]::after {
    content: ' ↑';
}

th[data-order="desc"]::after {
    content: ' ↓';
}
`;
document.head.appendChild(style);
</script>
{% endblock %}
{% endblock %}